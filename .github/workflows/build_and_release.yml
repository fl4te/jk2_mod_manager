name: Build & Release Monolith

permissions:
  contents: write

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  APP_VERSION: "1.0.5"

jobs:
  build:
    name: Build & Package (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    timeout-minutes: 60

    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]

    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install nuitka zstandard
          pip install -r requirements.txt

      # ------------------------
      # Build (Windows)
      # ------------------------
      - name: Build executable (Windows)
        if: matrix.os == 'windows-latest'
        shell: powershell
        run: |
          python -m nuitka `
            --standalone `
            --onefile `
            --disable-console `
            --enable-plugin=tk-inter `
            --assume-yes-for-downloads `
            --include-module=pil_config `
            --include-module=PIL.Image `
            --include-module=PIL.ImageTk `
            --include-module=PIL._tkinter_finder `
            --include-module=PIL.JpegImagePlugin `
            --include-module=PIL.PngImagePlugin `
            --include-module=PIL.TgaImagePlugin `
            --nofollow-import-to=PIL.BmpImagePlugin `
            --nofollow-import-to=PIL.GifImagePlugin `
            --nofollow-import-to=PIL.TiffImagePlugin `
            --nofollow-import-to=PIL.WebPImagePlugin `
            --nofollow-import-to=PIL.PdfImagePlugin `
            --nofollow-import-to=PIL.PcxImagePlugin `
            --nofollow-import-to=PIL.IcoImagePlugin `
            --nofollow-import-to=PIL.XpmImagePlugin `
            --nofollow-import-to=PIL.FtexImagePlugin `
            --windows-icon-from-ico=icon.ico `
            --lto=yes `
            --include-package-data=customtkinter `
            --output-dir=packaged `
            monolith.py

      # ------------------------
      # Build (Linux & macOS)
      # ------------------------
      - name: Build executable (Linux & macOS)
        if: matrix.os != 'windows-latest'
        shell: bash
        run: |
          set -e
          python -m nuitka \
            --standalone \
            --onefile \
            --enable-plugin=tk-inter \
            --assume-yes-for-downloads \
            --include-module=pil_config \
            --include-module=PIL.Image \
            --include-module=PIL.ImageTk \
            --include-module=PIL._tkinter_finder \
            --include-module=PIL.JpegImagePlugin \
            --include-module=PIL.PngImagePlugin \
            --include-module=PIL.TgaImagePlugin \
            --nofollow-import-to=PIL.BmpImagePlugin \
            --nofollow-import-to=PIL.GifImagePlugin \
            --nofollow-import-to=PIL.TiffImagePlugin \
            --nofollow-import-to=PIL.WebPImagePlugin \
            --nofollow-import-to=PIL.PdfImagePlugin \
            --nofollow-import-to=PIL.PcxImagePlugin \
            --nofollow-import-to=PIL.IcoImagePlugin \
            --nofollow-import-to=PIL.XpmImagePlugin \
            --nofollow-import-to=PIL.FtexImagePlugin \
            --include-package-data=customtkinter \
            --output-dir=packaged \
            monolith.py

      # ------------------------
      # Package Windows
      # ------------------------
      - name: Package Windows ZIP
        if: matrix.os == 'windows-latest'
        shell: powershell
        run: |
          mkdir final-dist -Force
          Compress-Archive packaged/monolith.exe final-dist/Monolith-windows.zip -Force

      # ------------------------
      # Package Linux
      # ------------------------
      - name: Package Linux tar.gz
        if: matrix.os == 'ubuntu-latest'
        shell: bash
        run: |
          set -e
          mkdir -p final-dist
          BIN_FILE=(packaged/monolith*)
          BIN_FILE="${BIN_FILE[0]}"
          tar -czvf final-dist/Monolith-linux.tar.gz -C packaged "$(basename "$BIN_FILE")"

      # ------------------------
      # Package macOS (.app + DMG)
      # ------------------------
      - name: Package macOS DMG
        if: matrix.os == 'macos-latest'
        shell: bash
        run: |
          set -e

          APP_NAME="Monolith"
          APP_DIR="dmg/${APP_NAME}.app"
          ICONSET="icon.iconset"

          mkdir -p "${APP_DIR}/Contents/MacOS" "${APP_DIR}/Contents/Resources"

          BIN_FILE=(packaged/monolith*)
          BIN_FILE="${BIN_FILE[0]}"
          cp "$BIN_FILE" "${APP_DIR}/Contents/MacOS/${APP_NAME}"
          chmod +x "${APP_DIR}/Contents/MacOS/${APP_NAME}"

          sips -s format png icon.ico --out icon.png
          mkdir -p "${ICONSET}"
          for SIZE in 16 32 64 128 256 512; do
            sips -z $SIZE $SIZE icon.png --out "${ICONSET}/icon_${SIZE}x${SIZE}.png"
          done
          cp "${ICONSET}/icon_512x512.png" "${ICONSET}/icon_512x512@2x.png"

          iconutil -c icns "${ICONSET}" -o "${APP_DIR}/Contents/Resources/icon.icns"
          rm -rf "${ICONSET}" icon.png

          cat > "${APP_DIR}/Contents/Info.plist" <<EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN"
            "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
            <dict>
              <key>CFBundleName</key>
              <string>${APP_NAME}</string>
              <key>CFBundleDisplayName</key>
              <string>${APP_NAME}</string>
              <key>CFBundleExecutable</key>
              <string>${APP_NAME}</string>
              <key>CFBundleIdentifier</key>
              <string>com.flate.monolith</string>
              <key>CFBundleIconFile</key>
              <string>icon.icns</string>
              <key>CFBundlePackageType</key>
              <string>APPL</string>
              <key>CFBundleVersion</key>
              <string>${APP_VERSION}</string>
              <key>CFBundleShortVersionString</key>
              <string>${APP_VERSION}</string>
              <key>NSHighResolutionCapable</key>
              <true/>
            </dict>
          </plist>
          EOF

          mkdir -p final-dist
          hdiutil create \
            -volname "${APP_NAME}" \
            -srcfolder dmg \
            -ov \
            -format UDZO \
            -imagekey zlib-level=9 \
            -fs HFS+ \
            final-dist/Monolith-macos.dmg

      # ------------------------
      # Upload artifacts
      # ------------------------
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: Monolith-${{ matrix.os }}
          path: final-dist/*

  release:
    needs: build
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - uses: actions/checkout@v4

      - uses: actions/download-artifact@v4
        with:
          path: release-assets
          merge-multiple: true

      - name: Create GitHub release
        shell: bash
        run: |
          TAG="v${{ env.APP_VERSION }}"

          gh release delete "$TAG" --yes || true

          # Delete tag if it already exists (ignore failure)
          git push origin --delete "$TAG" || true

          gh release create "$TAG" release-assets/* \
            --title "Release $TAG" \
            --notes "Automated build for version ${{ env.APP_VERSION }}"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

